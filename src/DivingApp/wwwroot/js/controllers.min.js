///<reference path="../../typings/angularjs/angular.d.ts" /> 
var Diving;
(function (Diving) {
    var Services;
    (function (Services) {
        var DataService = (function () {
            function DataService($http) {
                this.http = $http;
            }
            DataService.prototype.GetGeoPoints = function (email, callback) {
                this.http.get('/api/getdiveswithcoordinates/' + email).success(function (data, status) {
                    callback(data);
                }).error(function (error) {
                    callback(error);
                });
            };
            DataService.prototype.GetPhotosIds = function (email, diveId, minPhoto, callback) {
                this.http.get('/api/getuserphotoidsbydiveids/' + email + '/' + diveId + '/' + minPhoto).success(function (data, status) {
                    callback(data);
                }).error(function (error) {
                    callback(error);
                });
            };
            DataService.prototype.GetPhoto = function (email, photoId, callback) {
                this.http.get('GetPhoto/' + email + '/' + photoId).success(function (data, status) {
                    callback(data);
                }).error(function (error) {
                    callback(error);
                });
            };
            DataService.prototype.GetAuthorizedUserDives = function (callback) {
                this.http.get('/api/getuserdives').success(function (data, status) {
                    callback(data);
                }).error(function (error) {
                    callback(error);
                });
            };
            DataService.prototype.GetAuthorizedUserDiveById = function (diveId, callback) {
                this.http.get('/api/getuserdivebyid/' + diveId).success(function (data, status) {
                    callback(data);
                }).error(function (error) {
                    callback(error);
                });
            };
            DataService.prototype.GetDiveDictionaries = function (callback) {
                this.http.get('/api/getdivedictionaries').success(function (data, status) {
                    callback(data);
                }).error(function (error) {
                    callback(error);
                });
            };
            return DataService;
        })();
        Services.DataService = DataService;
    })(Services = Diving.Services || (Diving.Services = {}));
})(Diving || (Diving = {}));

///<reference path="../../typings/angularjs/angular.d.ts" /> 
var Diving;
(function (Diving) {
    var Controllers;
    (function (Controllers) {
        var loginController = (function () {
            function loginController($scope) {
                this.$scope = $scope;
                this.showLogin = true;
                this.showSearch = false;
                this.showSearchResults = false;
                this.showSearchNotFound = false;
            }
            loginController.prototype.showTab = function (tabIndex) {
                if (tabIndex == 1) {
                    this.showLogin = true;
                    this.showSearchResults = this.showSearch = false;
                }
                if (tabIndex == 2) {
                    this.showSearch = true;
                    this.showLogin = this.showSearchResults = false;
                }
                if (tabIndex == 3) {
                    this.showSearchResults = true;
                    this.showLogin = this.showSearch = false;
                }
            };
            loginController.prototype.searchDivers = function () {
                this.showSearchNotFound = false;
                $.ajax({
                    type: "GET",
                    url: "api/users/getusersbyname/" + this.searchCriteria,
                    cache: false,
                    context: this,
                    success: function (data) {
                        if (data.length > 0) {
                            this.showSearch = false;
                            this.showSearchResults = true;
                            this.searchResults = data;
                        }
                        else {
                            this.showSearchNotFound = true;
                        }
                        this.$scope.$apply();
                    }
                });
            };
            loginController.prototype.openPasp = function (id) {
                location.href = 'passport/external/' + id;
            };
            return loginController;
        })();
        Controllers.loginController = loginController;
    })(Controllers = Diving.Controllers || (Diving.Controllers = {}));
})(Diving || (Diving = {}));

///<reference path="../../typings/angularjs/angular.d.ts" /> 
///<reference path="../../typings/google.maps.d.ts" /> 
var Diving;
(function (Diving) {
    var Controllers;
    (function (Controllers) {
        var paspController = (function () {
            function paspController($scope, PaspService) {
                this.paspService = PaspService;
                this.selectedDiveId = -1;
                this.selectedPhotoIndex = -1;
                this.showDives = true;
                this.showMaps = false;
                this.showPhoto = false;
                this.showGeoDiveInfo = false;
                this.map = undefined;
                this.scope = $scope;
            }
            paspController.prototype.init = function (userEmail) {
                this.currentUserEmail = userEmail;
            };
            paspController.prototype.hidePhoto = function () {
                this.showPhoto = false;
            };
            paspController.prototype.showTab = function (tabIndex) {
                if (tabIndex == 1) {
                    this.showDives = true;
                    this.showMaps = false;
                }
                if (tabIndex == 2) {
                    this.showDives = false;
                    this.showMaps = true;
                    var that = this;
                    setTimeout(function () {
                        this.options = {
                            zoom: 2,
                            center: new google.maps.LatLng(1, 1),
                            mapTypeId: google.maps.MapTypeId.ROADMAP
                        };
                        if (!that.map) {
                            that.map = new google.maps.Map(document.getElementById('map'), this.options);
                            that.map.addListener('zoom_changed', function () {
                                that.showGeoDiveInfo = false;
                                that.scope.$apply();
                            });
                            that.map.addListener('click', function () {
                                that.showGeoDiveInfo = false;
                                that.scope.$apply();
                            });
                        }
                        that.paspService.GetGeoPoints(that.currentUserEmail, function (data) {
                            that.markers = [];
                            var marker;
                            for (var i = 0; i < data.length; i++) {
                                var clickHandler = function () {
                                    var currentDive = data[i];
                                    var diveId = data[i].DiveId;
                                    marker = new google.maps.Marker({
                                        map: that.map,
                                        draggable: false,
                                        title: data[i].Location + ": " + data[i].DiveComment,
                                        position: new google.maps.LatLng(data[i].CoordinateX, data[i].CoordinateY)
                                    });
                                    marker.data = data[i];
                                    marker.addListener('click', function (e) {
                                        that.selectedGeoDive = this.data;
                                        var overlay = new google.maps.OverlayView();
                                        overlay.draw = function () { };
                                        overlay.setMap(that.map);
                                        var proj = overlay.getProjection();
                                        var pos = this.getPosition();
                                        var p = proj.fromLatLngToContainerPixel(pos);
                                        $('#geoDiveDetails').css({
                                            top: p.y + $('#geoDiveDetails').parent().position().top - $('#geoDiveDetails').height(),
                                            left: p.x + 40,
                                            position: 'absolute'
                                        });
                                        that.showGeoDiveInfo = true;
                                        that.scope.$apply();
                                    });
                                    that.markers.push(marker);
                                };
                                clickHandler();
                            }
                            var marker = new MarkerClusterer(that.map, that.markers);
                        });
                    }, 100);
                }
            };
            paspController.prototype.getPhotos = function (diveId) {
                this.showGeoDiveInfo = false;
                this.resetPhoto();
                this.selectedDiveId = diveId;
                var that = this;
                this.paspService.GetPhotosIds(this.currentUserEmail, this.selectedDiveId, 0, function (data) {
                    that.photos = data;
                    if (that.photos.length > 0) {
                        that.selectedPhotoIndex = 0;
                        that.changeCurrentPhotoIndex(that.selectedPhotoIndex);
                    }
                });
            };
            paspController.prototype.showNext = function () {
                if (this.selectedPhotoIndex < this.photos.length - 1)
                    this.selectedPhotoIndex++;
                else
                    this.selectedPhotoIndex = 0;
                this.changeCurrentPhotoIndex(this.selectedPhotoIndex);
            };
            paspController.prototype.openPasp = function (id) {
                location.href = 'Pasp/PaspShow?login=' + id;
            };
            paspController.prototype.changeCurrentPhotoIndex = function (index) {
                if (index == -1)
                    this.hidePhoto();
                else {
                    var that = this;
                    this.paspService.GetPhoto(this.currentUserEmail, this.photos[this.selectedPhotoIndex], function (data) {
                        that.selectedPhotoInfo = new photoDetailes();
                        that.selectedPhotoInfo.photoId = that.photos[that.selectedPhotoIndex];
                        that.selectedPhotoInfo.photoDate = "Photo date: " + moment(data.Date).format('DD/MM/YYYY');
                        that.selectedPhotoInfo.photoInfo = data.Comment;
                        that.showPhoto = true;
                        that.scope.$apply();
                    });
                }
            };
            paspController.prototype.resetPhoto = function () {
                this.selectedPhotoIndex = -1;
                this.changeCurrentPhotoIndex(this.selectedPhotoIndex);
            };
            return paspController;
        })();
        Controllers.paspController = paspController;
        var photoDetailes = (function () {
            function photoDetailes() {
            }
            return photoDetailes;
        })();
        Controllers.photoDetailes = photoDetailes;
        var selectedGeoDetailes = (function () {
            function selectedGeoDetailes() {
            }
            return selectedGeoDetailes;
        })();
        Controllers.selectedGeoDetailes = selectedGeoDetailes;
    })(Controllers = Diving.Controllers || (Diving.Controllers = {}));
})(Diving || (Diving = {}));
var MarkerClusterer;
var moment;

///<reference path="../../../typings/angularjs/angular.d.ts" /> 
///<reference path="../../../typings/google.maps.d.ts" /> 
var Diving;
(function (Diving) {
    var Controllers;
    (function (Controllers) {
        var diveController = (function () {
            function diveController($scope, dataService) {
                this.dataService = dataService;
                this.selectedPhotoIndex = -1;
                this.selectedDiveId = -1;
                this.showLoadingTab = true;
                this.showDivesTab = false;
                this.showMapsTab = false;
                this.showPhotosTab = false;
                this.showPhoto = false;
                this.showPhotoDelete = false;
                this.showSearchingGeoStatus = false;
                this.map = undefined;
                this.scope = $scope;
                var that = this;
                dataService.GetDiveDictionaries(function (data) {
                    that.countries = data.Countries;
                    that.suits = data.Suits;
                    that.weights = data.Weights;
                    that.tanks = data.Tanks;
                });
                dataService.GetAuthorizedUserDives(function (data) {
                    that.dives = data;
                    if (data.length > 0) {
                        that.GetDive(data[0].DiveID);
                    }
                });
            }
            diveController.prototype.init = function (userEmail) {
                this.currentUserEmail = userEmail;
            };
            diveController.prototype.showSelectedDiveTab = function (tabIndex) {
                if (tabIndex == 0)
                    this.showLoadingTab = true;
                else {
                    this.showLoadingTab = false;
                    if (tabIndex == 1) {
                        this.showDivesTab = true;
                        this.showMapsTab = false;
                        this.showPhotosTab = false;
                    }
                    if (tabIndex == 2) {
                        this.showDivesTab = false;
                        this.showMapsTab = true;
                        this.showPhotosTab = false;
                        var that = this;
                        setTimeout(function () {
                            this.options = {
                                zoom: 6,
                                center: new google.maps.LatLng(that.selectedDive.Latitude, that.selectedDive.Longitude),
                                mapTypeId: google.maps.MapTypeId.ROADMAP
                            };
                            if (!that.map) {
                                that.map = new google.maps.Map(document.getElementById('map'), this.options);
                                that.map.addListener('zoom_changed', function () {
                                    that.scope.$apply();
                                });
                                that.map.addListener('click', function () {
                                    that.scope.$apply();
                                });
                                if (that.selectedDive && that.selectedDive.Latitude && that.selectedDive.Longitude) {
                                    that.marker = new google.maps.Marker({
                                        map: that.map,
                                        draggable: true,
                                        title: that.selectedDive.Location,
                                        position: new google.maps.LatLng(that.selectedDive.Latitude, that.selectedDive.Longitude)
                                    });
                                    google.maps.event.addListener(that.marker, 'dragend', function () {
                                        that.selectedDive.Latitude = that.marker.getPosition().lat().toFixed(6).replace(".", ",");
                                        that.selectedDive.Longitude = that.marker.getPosition().lng().toFixed(6).replace(".", ",");
                                    });
                                }
                            }
                        });
                    }
                    if (tabIndex == 3) {
                        this.showDivesTab = false;
                        this.showMapsTab = false;
                        this.showPhotosTab = true;
                    }
                }
            };
            diveController.prototype.searchForLocation = function () {
                this.marker.setMap(null);
                this.showSearchingGeoStatus = true;
                var geocoder = new google.maps.Geocoder();
                var that = this;
                geocoder.geocode({ 'address': this.location }, function (results, status) {
                    if (status == google.maps.GeocoderStatus.OK) {
                        var myOptions = {
                            zoom: 8,
                            center: results[0].geometry.location,
                            mapTypeId: google.maps.MapTypeId.ROADMAP
                        };
                        that.map = new google.maps.Map($("#map")[0], myOptions);
                        that.marker = new google.maps.Marker({
                            map: that.map,
                            draggable: true,
                            position: results[0].geometry.location
                        });
                        that.selectedDive.Latitude = results[0].geometry.location.lat().toFixed(6).replace(".", ",");
                        that.selectedDive.Longitude = results[0].geometry.location.lng().toFixed(6).replace(".", ",");
                        var lat = results[0].geometry.location.lat().toFixed(6).replace(".", ",");
                        var lgn = results[0].geometry.location.lng().toFixed(6).replace(".", ",");
                        google.maps.event.addListener(that.marker, 'dragend', function () {
                            that.selectedDive.Latitude = that.marker.getPosition().lat().toFixed(6).replace(".", ",");
                            that.selectedDive.Longitude = that.marker.getPosition().lng().toFixed(6).replace(".", ",");
                        });
                    }
                    else {
                        alert("Failed to make request to GEO service: " + status);
                    }
                    that.showSearchingGeoStatus = false;
                    that.scope.$apply();
                });
            };
            diveController.prototype.GetDive = function (diveId) {
                this.HidePhotoDelete();
                this.showSelectedDiveTab(0);
                this.selectedDiveId = diveId;
                var that = this;
                this.dataService.GetAuthorizedUserDiveById(diveId, function (data) {
                    that.location = "";
                    that.resetPhoto();
                    that.selectedDive = data;
                    that.showSelectedDiveTab(1);
                });
            };
            diveController.prototype.GetPhoto = function (id) {
                this.selectedPhotoIndex = this.selectedDive.Photos.map(function (e) { return e.PhotoId; }).indexOf(id);
                this.changeCurrentPhotoIndex(this.selectedPhotoIndex);
            };
            diveController.prototype.ShowNext = function () {
                if (this.selectedPhotoIndex < this.selectedDive.Photos.length - 1)
                    this.selectedPhotoIndex++;
                else
                    this.selectedPhotoIndex = 0;
                this.changeCurrentPhotoIndex(this.selectedPhotoIndex);
            };
            diveController.prototype.HidePhoto = function () {
                this.showPhoto = false;
            };
            diveController.prototype.ShowPhotoDelete = function () {
                this.showPhotoDelete = true;
            };
            diveController.prototype.HidePhotoDelete = function () {
                this.showPhotoDelete = false;
            };
            diveController.prototype.ShowDiveDelete = function (diveId) {
                this.dives[this.dives.map(function (e) { return e.DiveID; }).indexOf(diveId)].ShowDelete = true;
            };
            diveController.prototype.HideDiveDelete = function (diveId) {
                this.dives[this.dives.map(function (e) { return e.DiveID; }).indexOf(diveId)].ShowDelete = false;
            };
            diveController.prototype.changeCurrentPhotoIndex = function (index) {
                this.HidePhotoDelete();
                if (index == -1)
                    this.HidePhoto();
                else {
                    var that = this;
                    this.dataService.GetPhoto(this.currentUserEmail, this.selectedDive.Photos[this.selectedPhotoIndex], function (data) {
                        that.selectedPhotoInfo = new Controllers.photoDetailes();
                        that.selectedPhotoInfo.photoId = that.selectedDive.Photos[that.selectedPhotoIndex];
                        that.selectedPhotoInfo.photoDate = moment(data.Date).format('DD/MM/YYYY');
                        that.selectedPhotoInfo.photoInfo = data.Comment;
                        that.showPhoto = true;
                    });
                }
            };
            diveController.prototype.resetPhoto = function () {
                this.selectedPhotoIndex = -1;
                this.changeCurrentPhotoIndex(this.selectedPhotoIndex);
            };
            return diveController;
        })();
        Controllers.diveController = diveController;
    })(Controllers = Diving.Controllers || (Diving.Controllers = {}));
})(Diving || (Diving = {}));
var MarkerClusterer;
var moment;

var appModule = angular.module("diving-app", ['ngAnimate']);
appModule.controller("loginController", ['$scope', function ($scope) { return new Diving.Controllers.loginController($scope); }]);
appModule.controller('paspController', ['$scope', "DataService", Diving.Controllers.paspController]);
appModule.controller('diveController', ['$scope', "DataService", Diving.Controllers.diveController]);
appModule.factory("DataService", ["$http", function ($http) { return new Diving.Services.DataService($http); }]);
